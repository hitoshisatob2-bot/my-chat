<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kubota WSM aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f5f5f5; display: flex; flex-direction: column; align-items: center; padding-top: 50px; }
        .container { text-align: center; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        /* æ¤œç´¢çª“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .search-box { display: flex; align-items: center; background: #fff; border: 1px solid #dfe1e5; border-radius: 24px; padding: 5px 15px; margin: 20px 0; }
        .search-box input { flex: 1; border: none; outline: none; padding: 10px; font-size: 16px; }
        .mic-btn { background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; }
        .mic-btn.recording { color: red; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #send-btn { background: #4285f4; color: white; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>kubota WSM aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</h2>
    <p>éŸ³å£°ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã§è³ªå•ã—ã¦ãã ã•ã„</p>

    <div class="search-box">
        <input type="text" id="custom-search-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã€ã¾ãŸã¯ãƒã‚¤ã‚¯ã‚’ã‚¿ãƒƒãƒ—">
        <button id="custom-mic-btn" class="mic-btn">ğŸ™ï¸</button>
    </div>
    <button id="send-btn">AIã«è³ªå•ã™ã‚‹</button>
    <p id="status-msg" style="font-size: 12px; color: #666;"></p>
</div>

<div style="display:none;">
    <button id="hiddenTrigger">éš ã—ãƒœã‚¿ãƒ³</button>
</div>
<gen-search-widget
  configId="641e8208-ac63-4d51-a816-f864dfd00f27"
  triggerId="hiddenTrigger"
  max-results="1"
  enable-source-grounding="true"
  auth-type="public">
</gen-search-widget>

<script src="https://cloud.google.com/ai/gen-app-builder/client?hl=ja"></script>

<script>
    const inputField = document.getElementById('custom-search-input');
    const micBtn = document.getElementById('custom-mic-btn');
    const sendBtn = document.getElementById('send-btn');
    const statusMsg = document.getElementById('status-msg');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        micBtn.onclick = () => recognition.start();
        recognition.onstart = () => { micBtn.classList.add('recording'); statusMsg.innerText = "èãå–ã‚Šä¸­..."; };
        recognition.onend = () => { micBtn.classList.remove('recording'); };
        recognition.onresult = (event) => {
            inputField.value = event.results[0][0].transcript;
            statusMsg.innerText = "èªè­˜å®Œäº†ï¼ã€ŒAIã«è³ªå•ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        };
    }

    sendBtn.onclick = () => {
        const query = inputField.value;
        if (!query) return;

        document.getElementById('hiddenTrigger').click();
        statusMsg.innerText = "åŒæœŸã‚’è©¦è¡Œä¸­...";

        let count = 0;
        const syncInterval = setInterval(() => {
            count++;
            const widget = document.querySelector('gen-search-widget');
            const realInput = widget?.shadowRoot?.querySelector('input[type="search"]') || 
                                widget?.shadowRoot?.querySelector('input');

            if (realInput) {
                clearInterval(syncInterval);
                
                // ğŸš€ ã€ç‰¹æ®Šãªåˆå›³ã€‘ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€Œã‚³ãƒãƒ³ãƒ‰ã€ã‚’ä½¿ã£ã¦å…¥åŠ›ã•ã›ã‚‹
                realInput.focus();
                
                // æ‰‹é †1: 1æ–‡å­—ãšã¤æµã—è¾¼ã‚€ï¼ˆinputã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ãªãŒã‚‰ï¼‰
                let i = 0;
                const typeChar = () => {
                    if (i < query.length) {
                        const char = query.charAt(i);
                        // inputã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹
                        realInput.setRangeText(char, realInput.selectionStart, realInput.selectionEnd, 'end');
                        realInput.dispatchEvent(new InputEvent('input', { data: char, inputType: 'insertText', bubbles: true }));
                        i++;
                        setTimeout(typeChar, 10); // 10msé–“éš”ã§é«˜é€Ÿã‚¿ã‚¤ãƒ”ãƒ³ã‚°
                    } else {
                        // æ‰‹é †2: å®Œäº†å¾Œã«Enterã‚’é€£æ‰“
                        setTimeout(() => {
                            const enterData = { key: 'Enter', code: 'Enter', keyCode: 13, which: 13, bubbles: true };
                            realInput.dispatchEvent(new KeyboardEvent('keydown', enterData));
                            realInput.dispatchEvent(new KeyboardEvent('keypress', enterData));
                            realInput.dispatchEvent(new KeyboardEvent('keyup', enterData));
                            
                            // æ‰‹é †3: å¼·åˆ¶çš„ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã™ã‚‹å‘½ä»¤ã‚’å‡ºã™
                            const form = realInput.closest('form');
                            if (form) form.dispatchEvent(new Event('submit', { bubbles: true }));
                            
                            statusMsg.innerText = "é€ä¿¡ã—ã¾ã—ãŸã€‚";
                        }, 100);
                    }
                };
                typeChar();
            }
            if (count > 50) clearInterval(syncInterval);
        }, 100);
    };
</script>

</body>
</html>
