<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kubota WSM AI</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background-color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 85%;
      max-width: 420px;
    }
    /* ğŸš€ å·¨å¤§ãªãƒœã‚¿ãƒ³ */
    .main-btn {
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 20px 40px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(66,133,244,0.4);
      transition: transform 0.2s;
      width: 100%;
      max-width: 320px;
    }
    .main-btn:active { transform: scale(0.95); }
 
    /* ğŸ¤ éŸ³å£°é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆæ–¹å¼Aï¼‰ */
    .voice-btn {
      background: #34a853;
      box-shadow: 0 5px 15px rgba(52,168,83,0.35);
      margin-top: 14px;
    }
    .voice-btn:active { transform: scale(0.95); }
 
    .note {
      color: #666;
      margin-bottom: 22px;
      line-height: 1.5;
    }
    .small {
      font-size: 12px;
      color: #999;
      margin-top: 18px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
 
  <div class="container">
    <h2 style="margin-bottom: 18px;">kubota WSM AI.n</h2>
 
    <p class="note">
      ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹ã—ã¾ã™ã€‚<br>
      <b>éŸ³å£°ã§é€ã‚‹å ´åˆã¯ã€ŒéŸ³å£°ã§è³ªå•ã—ã¦é€ä¿¡ã€</b> ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
    </p>
 
    <!-- æ—¢å­˜ï¼šã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’é–‹ããƒœã‚¿ãƒ³ -->
    <button id="start-btn" class="main-btn">AIãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹</button>
 
    <!-- æ–¹å¼Aï¼šãƒšãƒ¼ã‚¸å´ã§éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆâ†’é€ä¿¡ã¾ã§ -->
    <button id="voice-send-btn" class="main-btn voice-btn">éŸ³å£°ã§è³ªå•ã—ã¦é€ä¿¡</button>
 
    <div class="small">
      â€» éŸ³å£°å…¥åŠ›ã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ã§ã™ã€‚<br>
      å…¥åŠ›æ¬„ã¸è‡ªå‹•é€ä¿¡ã§ããªã„å ´åˆã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ¡ˆå†…ã—ã¾ã™ã€‚
    </div>
  </div>
 
  <!-- Vertex AI Search Widget -->
  <gen-search-widget
    configId="641e8208-ac63-4d51-a816-f864dfd00f27"
    triggerId="start-btn"
    max-results="1"
    enable-source-grounding="true"
    enable-voice-search="true">
  </gen-search-widget>
 
  <script src="https://cloud.google.com/ai/gen-app-builder/client?hl=ja"></script>
 
  <script>
  (() => {
    // --- éŸ³å£°èªè­˜ï¼ˆWeb Speech APIï¼‰ ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
 
    const startBtn = document.getElementById('start-btn');
    const voiceBtn = document.getElementById('voice-send-btn');
 
    // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®å…¥åŠ›æ¬„ã‚’æ¢ã™ï¼ˆè¦‹ã¤ã‹ã‚Œã°è‡ªå‹•é€ä¿¡ï¼‰
    async function findWidgetInput() {
      // 1) ã¾ãšã¯è¡¨ç¤ºä¸­ã® input/textarea ã‚’åºƒãæ¢ç´¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒ body ç›´ä¸‹ã«å‡ºã‚‹å®Ÿè£…ã‚‚ã‚ã‚‹ï¼‰
      const visible = (el) => el && el.offsetParent !== null;
 
      const nodes = Array.from(document.querySelectorAll('input, textarea')).filter(visible);
 
      // ãã‚Œã£ã½ã„ã‚‚ã®ã‚’å„ªå…ˆï¼ˆplaceholder / aria-label ã« search/æ¤œç´¢ ãŒã‚ã‚‹ç­‰ï¼‰
      const scored = nodes.map(el => {
        const ph = (el.placeholder || '').toLowerCase();
        const al = (el.getAttribute('aria-label') || '').toLowerCase();
        const score =
          (ph.includes('search') || ph.includes('æ¤œç´¢') ? 3 : 0) +
          (al.includes('search') || al.includes('æ¤œç´¢') ? 3 : 0);
        return { el, score };
      }).sort((a, b) => b.score - a.score);
 
      if (scored.length && scored[0].score > 0) return scored[0].el;
 
      // 2) gen-search-widget ã® shadowRoot ãŒ open ã®å ´åˆã ã‘æ´ã‚ã‚‹
      const widget = document.querySelector('gen-search-widget');
      if (widget && widget.shadowRoot) {
        const el = widget.shadowRoot.querySelector('input, textarea');
        if (el) return el;
      }
 
      return null;
    }
 
    function dispatchEnter(el) {
      el.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', bubbles: true }));
      el.dispatchEvent(new KeyboardEvent('keyup',   { key: 'Enter', code: 'Enter', bubbles: true }));
    }
 
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        return false;
      }
    }
 
    // éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆâ†’é€ä¿¡
    voiceBtn.addEventListener('click', async () => {
      if (!SpeechRecognition) {
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ï¼ˆWeb Speech APIï¼‰ã«æœªå¯¾å¿œã§ã™ã€‚Chrome / Edge ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
        return;
      }
 
      // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’é–‹ãï¼ˆé–‰ã˜ã¦ã„ã‚‹ã¨å…¥åŠ›æ¬„ãŒç„¡ã„ã“ã¨ãŒã‚ã‚‹ï¼‰
      startBtn.click();
 
      const rec = new SpeechRecognition();
      rec.lang = 'ja-JP';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
 
      rec.onresult = async (e) => {
        const text = e.results[0][0].transcript;
 
        // å…¥åŠ›æ¬„ã‚’æ¢ã™
        const input = await findWidgetInput();
 
        if (!input) {
          const copied = await copyToClipboard(text);
          alert(
            (copied ? 'éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚' : 'éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸã€‚') +
            '\nã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦é€ä¿¡ã—ã¦ãã ã•ã„ï¼š\n\n' + text
          );
          return;
        }
 
        // å…¥åŠ›â†’ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«â†’Enter
        input.focus();
        input.value = text;
        input.dispatchEvent(new Event('input', { bubbles: true }));
        dispatchEnter(input);
      };
 
      rec.onerror = (e) => {
        alert('éŸ³å£°å…¥åŠ›ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (e.error || 'unknown'));
      };
 
      rec.start();
    });
  })();
  </script>
 
</body>
</html>
 
