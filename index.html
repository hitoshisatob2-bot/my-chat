<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kubota WSM AI</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background-color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 85%;
      max-width: 420px;
    }
    /* ğŸš€ å·¨å¤§ãªãƒœã‚¿ãƒ³ */
    .main-btn {
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 20px 40px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(66,133,244,0.4);
      transition: transform 0.2s;
      width: 100%;
      max-width: 320px;
    }
    .main-btn:active { transform: scale(0.95); }
 
    /* ğŸ¤ éŸ³å£°é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆæ–¹å¼Aï¼‰ */
    .voice-btn {
      background: #34a853;
      box-shadow: 0 5px 15px rgba(52,168,83,0.35);
      margin-top: 14px;
    }
    .voice-btn:active { transform: scale(0.95); }
 
    .note {
      color: #666;
      margin-bottom: 22px;
      line-height: 1.5;
    }
    .small {
      font-size: 12px;
      color: #999;
      margin-top: 18px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
 
  <div class="container">
    <h2 style="margin-bottom: 18px;">kubota WSM AI.o</h2>
 
    <p class="note">
      ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹ã—ã¾ã™ã€‚<br>
      <b>éŸ³å£°ã§é€ã‚‹å ´åˆã¯ã€ŒéŸ³å£°ã§è³ªå•ã—ã¦é€ä¿¡ã€</b> ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
    </p>
 
    <!-- æ—¢å­˜ï¼šã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’é–‹ããƒœã‚¿ãƒ³ -->
    <button id="start-btn" class="main-btn">AIãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹</button>
 
    <!-- æ–¹å¼Aï¼šãƒšãƒ¼ã‚¸å´ã§éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆâ†’é€ä¿¡ã¾ã§ -->
    <button id="voice-send-btn" class="main-btn voice-btn">éŸ³å£°ã§è³ªå•ã—ã¦é€ä¿¡</button>
 
    <div class="small">
      â€» éŸ³å£°å…¥åŠ›ã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ã§ã™ã€‚<br>
      å…¥åŠ›æ¬„ã¸è‡ªå‹•é€ä¿¡ã§ããªã„å ´åˆã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ¡ˆå†…ã—ã¾ã™ã€‚
    </div>
  </div>
 
  <!-- Vertex AI Search Widget -->
  <gen-search-widget
    configId="641e8208-ac63-4d51-a816-f864dfd00f27"
    triggerId="start-btn"
    max-results="1"
    enable-source-grounding="true"
    enable-voice-search="true">
  </gen-search-widget>
 
  <script src="https://cloud.google.com/ai/gen-app-builder/client?hl=ja"></script>
 
<script>
(() => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
 
  const startBtn = document.getElementById('start-btn');
  const voiceBtn = document.getElementById('voice-send-btn');
 
  // ç”»é¢ä¸Šã«è¦‹ãˆã¦ã„ã‚‹è¦ç´ ã ã‘
  const visible = (el) => el && el.getClientRects && el.getClientRects().length > 0;
 
  // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ç³»ãŒ value å¤‰æ›´ã‚’æ‹¾ã†ã‚ˆã†ã« â€œãƒã‚¤ãƒ†ã‚£ãƒ– setterâ€ ã§å…¥ã‚Œã‚‹
  function setNativeValue(el, value) {
    const proto = Object.getPrototypeOf(el);
    const desc = Object.getOwnPropertyDescriptor(proto, 'value');
    if (desc && desc.set) desc.set.call(el, value);
    else el.value = value;
  }
 
  // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®ã€Œå…¥åŠ›æ¬„ã£ã½ã„ã‚‚ã®ã€ã‚’æ‹¾ã†
  function findBestInput() {
    const candidates = Array.from(document.querySelectorAll('input, textarea'))
      .filter(visible)
      .filter(el => (el.type || '').toLowerCase() !== 'hidden');
 
    const scored = candidates.map(el => {
      const ph = (el.placeholder || '').toLowerCase();
      const al = (el.getAttribute('aria-label') || '').toLowerCase();
      const role = (el.getAttribute('role') || '').toLowerCase();
      const score =
        (ph.includes('search') || ph.includes('æ¤œç´¢') ? 3 : 0) +
        (al.includes('search') || al.includes('æ¤œç´¢') ? 3 : 0) +
        (role.includes('search') ? 1 : 0);
      return { el, score };
    }).sort((a,b) => b.score - a.score);
 
    // ãã‚Œã£ã½ã„ã®ãŒç„¡ã„å ´åˆã¯ â€œæœ€ã‚‚ç”»é¢ä¸­å¤®ã«è¿‘ã„å…¥åŠ›â€ ã‚’è¿”ã™
    if (!scored.length || scored[0].score === 0) {
      const cx = window.innerWidth / 2;
      const cy = window.innerHeight / 2;
      const byCenter = candidates.map(el => {
        const r = el.getBoundingClientRect();
        const dx = (r.left + r.width/2) - cx;
        const dy = (r.top + r.height/2) - cy;
        return { el, d: Math.hypot(dx, dy) };
      }).sort((a,b)=>a.d-b.d);
      return byCenter[0]?.el || null;
    }
    return scored[0].el;
  }
 
  // ã€Œé€ä¿¡/æ¤œç´¢ã€ãƒœã‚¿ãƒ³ã£ã½ã„ã‚‚ã®ã‚’æ¢ã—ã¦ã‚¯ãƒªãƒƒã‚¯
  function clickSendButton() {
    const buttons = Array.from(document.querySelectorAll('button, [role="button"]'))
      .filter(visible);
 
    const hit = buttons.find(b => {
      const t = (b.textContent || '').trim();
      const al = (b.getAttribute('aria-label') || '').trim();
      const title = (b.getAttribute('title') || '').trim();
      const s = (t + ' ' + al + ' ' + title).toLowerCase();
      return (
        s.includes('search') ||
        s.includes('æ¤œç´¢') ||
        s.includes('é€ä¿¡') ||
        s.includes('send') ||
        s.includes('submit')
      );
    });
 
    if (hit) {
      hit.click();
      console.log('[voice-send] clicked send/search button:', hit);
      return true;
    }
    return false;
  }
 
  function pressEnter(el) {
    el.dispatchEvent(new KeyboardEvent('keydown', { key:'Enter', code:'Enter', bubbles:true }));
    el.dispatchEvent(new KeyboardEvent('keypress', { key:'Enter', code:'Enter', bubbles:true }));
    el.dispatchEvent(new KeyboardEvent('keyup', { key:'Enter', code:'Enter', bubbles:true }));
  }
 
  async function copyToClipboard(text) {
    try { await navigator.clipboard.writeText(text); return true; }
    catch(e){ return false; }
  }
 
  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”Ÿæˆã‚’å¾…ã¡ãªãŒã‚‰ã€Œå…¥åŠ›â†’é€ä¿¡ã€ã‚’è¤‡æ•°å›è©¦ã™
  async function injectAndSubmit(text) {
    // æœ€å¤§ 25 å›ãƒªãƒˆãƒ©ã‚¤ï¼ˆç´„2.5ç§’æƒ³å®šï¼‰
    for (let i=0; i<25; i++) {
      const input = findBestInput();
      if (input) {
        console.log('[voice-send] found input:', input);
 
        input.focus();
        setNativeValue(input, text);
 
        // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸å¯§ã«
        input.dispatchEvent(new Event('input', { bubbles:true }));
        input.dispatchEvent(new Event('change', { bubbles:true }));
 
        // 1) Enter
        pressEnter(input);
 
        // 2) é€ä¿¡ãƒœã‚¿ãƒ³ã‚‚ã‚¯ãƒªãƒƒã‚¯
        const clicked = clickSendButton();
 
        // Network ãŒèµ°ã‚‹å ´åˆã€ã“ã“ã§æˆåŠŸã™ã‚‹ã“ã¨ãŒå¤šã„
        // é€£æ‰“ã‚’é¿ã‘ã‚‹ãŸã‚ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ããŸã‚‰ä¸€æ—¦æŠœã‘ã‚‹
        if (clicked) return true;
 
        // Enter ã ã‘ã§èµ°ã‚‹å®Ÿè£…ã‚‚ã‚ã‚‹ã®ã§ã€ã“ã“ã§å°‘ã—å¾…ã£ã¦çµ‚äº†
        await new Promise(r => setTimeout(r, 150));
        return true;
      }
 
      // input ãŒã¾ã ã„ãªã„ï¼šå°‘ã—å¾…ã¤
      await new Promise(r => setTimeout(r, 100));
    }
 
    // ã©ã†ã—ã¦ã‚‚æ´ã‚ãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const copied = await copyToClipboard(text);
    alert(
      (copied ? 'éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚' : 'éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸã€‚') +
      '\nã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦é€ä¿¡ã—ã¦ãã ã•ã„ï¼š\n\n' + text
    );
    return false;
  }
 
  voiceBtn.addEventListener('click', async () => {
    if (!SpeechRecognition) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ï¼ˆWeb Speech APIï¼‰ã«æœªå¯¾å¿œã§ã™ã€‚Chrome / Edge ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
      return;
    }
 
    // å…ˆã«ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’é–‹ãï¼ˆå…¥åŠ›æ¬„ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
    startBtn?.click();
 
    const rec = new SpeechRecognition();
    rec.lang = 'ja-JP';
    rec.interimResults = false;
    rec.maxAlternatives = 1;
 
    rec.onresult = async (e) => {
      const text = e.results[0][0].transcript;
      console.log('[voice-send] transcript:', text);
 
      // é€ä¿¡å‡¦ç†
      await injectAndSubmit(text);
    };
 
    rec.onerror = (e) => {
      console.log('[voice-send] speech error:', e);
      alert('éŸ³å£°å…¥åŠ›ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (e.error || 'unknown'));
    };
 
    rec.start();
  });
})();
</script>
 
 
</body>
</html>
 
