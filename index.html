<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kubota WSM aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f5f5f5; display: flex; flex-direction: column; align-items: center; padding-top: 50px; }
        .container { text-align: center; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        /* æ¤œç´¢çª“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .search-box { display: flex; align-items: center; background: #fff; border: 1px solid #dfe1e5; border-radius: 24px; padding: 5px 15px; margin: 20px 0; }
        .search-box input { flex: 1; border: none; outline: none; padding: 10px; font-size: 16px; }
        .mic-btn { background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; }
        .mic-btn.recording { color: red; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #send-btn { background: #4285f4; color: white; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>kubota WSM aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</h2>
    <p>éŸ³å£°ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã§è³ªå•ã—ã¦ãã ã•ã„</p>

    <div class="search-box">
        <input type="text" id="custom-search-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã€ã¾ãŸã¯ãƒã‚¤ã‚¯ã‚’ã‚¿ãƒƒãƒ—">
        <button id="custom-mic-btn" class="mic-btn">ğŸ™ï¸</button>
    </div>
    <button id="send-btn">AIã«è³ªå•ã™ã‚‹</button>
    <p id="status-msg" style="font-size: 12px; color: #666;"></p>
</div>

<div style="display:none;">
    <button id="hiddenTrigger">éš ã—ãƒœã‚¿ãƒ³</button>
</div>
<gen-search-widget
  configId="641e8208-ac63-4d51-a816-f864dfd00f27"
  triggerId="hiddenTrigger"
  max-results="1"
  enable-source-grounding="true"
  auth-type="public">
</gen-search-widget>

<script src="https://cloud.google.com/ai/gen-app-builder/client?hl=ja"></script>

<script>
    const inputField = document.getElementById('custom-search-input');
    const micBtn = document.getElementById('custom-mic-btn');
    const sendBtn = document.getElementById('send-btn');
    const statusMsg = document.getElementById('status-msg');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';

        micBtn.onclick = () => recognition.start();
        recognition.onstart = () => { micBtn.classList.add('recording'); statusMsg.innerText = "èãå–ã‚Šä¸­..."; };
        recognition.onend = () => { micBtn.classList.remove('recording'); };
        
        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            inputField.value = text;
            statusMsg.innerText = "èªè­˜ã—ã¾ã—ãŸã€‚ã€ŒAIã«è³ªå•ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        };
    }

    // ğŸš€ ã“ã“ã‚’å¤§å¹…ã«å¼·åŒ–ã—ã¾ã—ãŸï¼
    sendBtn.onclick = () => {
        const query = inputField.value;
        if (!query) return;

        statusMsg.innerText = "AIã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™...";

        // 1. Googleã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’èµ·å‹•ï¼ˆéš ã—ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰
        document.getElementById('hiddenTrigger').click();

        // 2. ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆå†…ã®æœ¬ç‰©ã®å…¥åŠ›çª“ã‚’æ¢ã—ã¦ã€å¾¹åº•çš„ã«åŒæœŸã•ã›ã‚‹
        let attempts = 0;
        const forceInput = setInterval(() => {
            attempts++;
            const widget = document.querySelector('gen-search-widget');
            const realInput = widget?.shadowRoot?.querySelector('input[type="search"]');

            if (realInput) {
                clearInterval(forceInput);
                
                // æ–‡å­—ã‚’ã‚»ãƒƒãƒˆ
                realInput.value = query;
                
                // ã€Œäººé–“ãŒå…¥åŠ›ã—ãŸã€ã¨ã„ã†ä¿¡å·ã‚’å…¨éƒ¨é€ã‚‹
                realInput.dispatchEvent(new Event('input', { bubbles: true }));
                realInput.dispatchEvent(new Event('change', { bubbles: true }));

                // Enterã‚­ãƒ¼ã®é€£æ‰“ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã§å®Ÿè¡Œã‚’è©¦ã¿ã‚‹ï¼‰
                const enterData = { key: 'Enter', code: 'Enter', keyCode: 13, which: 13, bubbles: true };
                realInput.dispatchEvent(new KeyboardEvent('keydown', enterData));
                
                // ã‚¹ãƒãƒ›ç”¨ã«å°‘ã—é…ã‚‰ã›ã¦ã‹ã‚‰å†åº¦Enter
                setTimeout(() => {
                    realInput.dispatchEvent(new KeyboardEvent('keyup', enterData));
                    statusMsg.innerText = "é€ä¿¡å®Œäº†ï¼å›ç­”ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚";
                }, 100);
            }

            if (attempts > 40) { // 4ç§’å¾…ã£ã¦ã‚‚ãƒ€ãƒ¡ãªå ´åˆ
                clearInterval(forceInput);
                statusMsg.innerText = "é€šä¿¡ãŒæ··ã¿åˆã£ã¦ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
            }
        }, 100); 
    };
</script>

</body>
</html>
