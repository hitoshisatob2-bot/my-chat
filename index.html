<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kubota WSM aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f5f5f5; display: flex; flex-direction: column; align-items: center; padding-top: 50px; }
        .container { text-align: center; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        /* æ¤œç´¢çª“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .search-box { display: flex; align-items: center; background: #fff; border: 1px solid #dfe1e5; border-radius: 24px; padding: 5px 15px; margin: 20px 0; }
        .search-box input { flex: 1; border: none; outline: none; padding: 10px; font-size: 16px; }
        .mic-btn { background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; }
        .mic-btn.recording { color: red; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #send-btn { background: #4285f4; color: white; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>kubota WSM aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</h2>
    <p>éŸ³å£°ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã§è³ªå•ã—ã¦ãã ã•ã„</p>

    <div class="search-box">
        <input type="text" id="custom-search-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã€ã¾ãŸã¯ãƒã‚¤ã‚¯ã‚’ã‚¿ãƒƒãƒ—">
        <button id="custom-mic-btn" class="mic-btn">ğŸ™ï¸</button>
    </div>
    <button id="send-btn">AIã«è³ªå•ã™ã‚‹</button>
    <p id="status-msg" style="font-size: 12px; color: #666;"></p>
</div>

<div style="display:none;">
    <button id="hiddenTrigger">éš ã—ãƒœã‚¿ãƒ³</button>
</div>
<gen-search-widget
  configId="641e8208-ac63-4d51-a816-f864dfd00f27"
  triggerId="hiddenTrigger"
  max-results="1"
  enable-source-grounding="true"
  auth-type="public">
</gen-search-widget>

<script src="https://cloud.google.com/ai/gen-app-builder/client?hl=ja"></script>

<script>
    const inputField = document.getElementById('custom-search-input');
    const micBtn = document.getElementById('custom-mic-btn');
    const sendBtn = document.getElementById('send-btn');
    const statusMsg = document.getElementById('status-msg');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        micBtn.onclick = () => recognition.start();
        recognition.onstart = () => { micBtn.classList.add('recording'); statusMsg.innerText = "èãå–ã‚Šä¸­..."; };
        recognition.onend = () => { micBtn.classList.remove('recording'); };
        recognition.onresult = (event) => {
            inputField.value = event.results[0][0].transcript;
            statusMsg.innerText = "èªè­˜ã—ã¾ã—ãŸã€‚ã€ŒAIã«è³ªå•ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        };
    }

    sendBtn.onclick = () => {
        const query = inputField.value;
        if (!query) return;

        // 1. Googleã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’èµ·å‹•
        document.getElementById('hiddenTrigger').click();
        statusMsg.innerText = "å›ç­”ã‚’æº–å‚™ä¸­...";

        // 2. çª“ãŒè¦‹ã¤ã‹ã‚‹ã¾ã§ã€ã—ã¤ã“ãæ¢ã—ç¶šã‘ã¦æ–‡å­—ã‚’å©ãè¾¼ã‚€
        let count = 0;
        const syncInterval = setInterval(() => {
            count++;
            const widget = document.querySelector('gen-search-widget');
            // Shadow DOMã®å¥¥æ·±ãã«ã‚ã‚‹å…¥åŠ›çª“ã‚’ç‰¹å®šã™ã‚‹æœ€å¼·ã®ãƒ‘ã‚¹
            const realInput = widget?.shadowRoot?.querySelector('input[type="search"]') || 
                                widget?.shadowRoot?.querySelector('.Ds9S6c') || 
                                widget?.shadowRoot?.querySelector('input');

            if (realInput) {
                clearInterval(syncInterval);
                
                // æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ã€Œäººé–“ãŒæ‰“ã£ãŸã€ã¨èªè­˜ã•ã›ã‚‹
                realInput.focus();
                realInput.value = query;
                realInput.dispatchEvent(new Event('input', { bubbles: true }));
                
                // Enterã‚­ãƒ¼ã‚’3ã¤ã®æ–¹æ³•ã§é€£ç¶šå®Ÿè¡Œ
                const enterData = { key: 'Enter', code: 'Enter', keyCode: 13, which: 13, bubbles: true };
                realInput.dispatchEvent(new KeyboardEvent('keydown', enterData));
                
                // å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã—ã«ã„ãï¼ˆå¿µæŠ¼ã—ï¼‰
                const searchBtn = widget?.shadowRoot?.querySelector('button[aria-label="æ¤œç´¢"]') || 
                                  widget?.shadowRoot?.querySelector('.VfPpkd-Bz112c-LgbsSe');
                if (searchBtn) searchBtn.click();
                
                statusMsg.innerText = "é€ä¿¡ã—ã¾ã—ãŸï¼";
            }

            if (count > 50) clearInterval(syncInterval); // 5ç§’æ¢ã—ã¦ãƒ€ãƒ¡ãªã‚‰ä¸­æ­¢
        }, 100);
    };
</script>

</body>
</html>
